// SIMPLIFIED PRISMA SCHEMA - CHỈ 2 BẢNG CHÍNH
// Loại bỏ complexity không cần thiết, tập trung vào business logic

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"] // Enable extensions preview
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// BẢNG CHÍNH - User Authentication và thông tin cơ bản
model User {
  id           Int     @id @default(autoincrement())
  email        String? @unique @db.VarChar(255)
  phoneNumber  String? @unique @map("phone_number") @db.VarChar(20)
  passwordHash String? @map("password_hash") @db.VarChar(255)

  // Web2.5 - Solana Wallet Integration
  walletAddress String? @unique @map("wallet_address") @db.VarChar(44)

  // Web2.5 - Reputation & Token System (UPDATED for MVP)
  ksScore       Float @default(0.0) @map("ks_score") // Knowledge Score - Reputation
  trustLevel    Int   @default(1) @map("trust_level") // Calculated based on KS
  
  reputationScore Int   @default(0) @map("reputation_score") // Legacy/Display
  knowUBalance    Int   @default(0) @map("know_u_balance") // Off-chain Points (Integer)
  knowGBalance    Float @default(0.0) @map("know_g_balance") // On-chain Token (Decimal/Float)

  // Account status
  accountStatus   AccountStatus @default(ACTIVE) @map("account_status")
  isEmailVerified Boolean       @default(false) @map("is_email_verified")
  isPhoneVerified Boolean       @default(false) @map("is_phone_verified")

  // Role đơn giản - không cần bảng riêng
  role UserRole @default(USER)

  // Login info
  lastLoginAt   DateTime? @map("last_login_at")
  loginAttempts Int       @default(0) @map("login_attempts")
  lockedUntil   DateTime? @map("locked_until")

  // Email OTP abuse protection
  emailOtpAttempts     Int       @default(0) @map("email_otp_attempts")
  emailOtpLastSentAt   DateTime? @map("email_otp_last_sent_at")
  emailOtpLockedUntil  DateTime? @map("email_otp_locked_until")

  // Security tokens (chỉ khi cần)
  passwordResetToken     String?   @map("password_reset_token") @db.VarChar(255)
  passwordResetExpiresAt DateTime? @map("password_reset_expires_at")
  emailVerificationToken String?   @map("email_verification_token") @db.VarChar(255)
  emailVerificationExpiresAt DateTime? @map("email_verification_expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  profile           UserProfile?
  conversations     Conversation[]
  favoriteLocations FavoriteLocation[]
  restaurants       Restaurant[]
  articles          Article[]
  votes             Vote[]
  transactions      Transaction[]
  pointTransactions PointTransaction[] 
  places            Place[]
  refreshTokens     RefreshToken[]

  // Web2 Features Relations
  articleEdits ArticleHistory[] @relation("ArticleEditor")
  series       Series[]
  badges       UserBadge[]

  // New Relations for MVP
  interactions Interaction[]
  suggestions  Suggestion[]

  @@index([email], map: "idx_email")
  @@index([phoneNumber], map: "idx_phone_number")
  @@index([walletAddress], map: "idx_wallet_address")
  @@index([ksScore(sort: Desc)], map: "idx_ks_score") // Index for reputation ranking
  @@index([accountStatus], map: "idx_account_status")
  @@index([role], map: "idx_role")
  @@map("users")
}

model RefreshToken {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  tokenHash  String   @unique @map("token_hash") @db.VarChar(255)
  userAgent  String?  @map("user_agent") @db.VarChar(255)
  ipAddress  String?  @map("ip_address") @db.VarChar(64)
  revoked    Boolean  @default(false)
  replacedBy String?  @map("replaced_by") @db.VarChar(255)
  expiresAt  DateTime @map("expires_at")
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_refresh_user")
  @@index([revoked], map: "idx_refresh_revoked")
  @@index([expiresAt], map: "idx_refresh_expires")
  @@map("refresh_tokens")
}

// BẢNG PROFILE - Thông tin cá nhân chi tiết
model UserProfile {
  id     Int @id @default(autoincrement())
  userId Int @unique @map("user_id")

  // Display info
  displayName String  @map("display_name") @db.VarChar(100)
  firstName   String? @map("first_name") @db.VarChar(50)
  lastName    String? @map("last_name") @db.VarChar(50)
  avatarUrl   String? @map("avatar_url") @db.VarChar(500)

  // Personal info
  bio         String?   @db.Text
  birthDate   DateTime? @map("birth_date") @db.Date
  gender      Gender?
  phoneNumber String?   @map("phone_number") @db.VarChar(20)

  // Address
  country String? @db.VarChar(100)
  city    String? @db.VarChar(100)
  address String? @db.Text

  // Preferences
  language        String  @default("vi") @db.VarChar(5)
  timezone        String  @default("Asia/Ho_Chi_Minh") @db.VarChar(50)
  isProfilePublic Boolean @default(true) @map("is_profile_public")

  // Notifications
  emailNotifications Boolean @default(true) @map("email_notifications")
  pushNotifications  Boolean @default(true) @map("push_notifications")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([displayName], map: "idx_display_name")
  @@index([isProfilePublic], map: "idx_is_public")
  @@map("user_profiles")
}

// CHATBOT MODELS
model Conversation {
  id        String   @id @default(cuid())
  userId    Int      @map("user_id")
  title     String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([userId], map: "idx_conversation_user")
  @@index([updatedAt], map: "idx_conversation_updated")
  @@map("conversations")
}

model Message {
  id             String   @id @default(cuid())
  conversationId String   @map("conversation_id")
  content        String   @db.Text
  isUser         Boolean  @map("is_user")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId], map: "idx_message_conversation")
  @@index([createdAt], map: "idx_message_created")
  @@map("messages")
}

// MAP MODELS
model FavoriteLocation {
  id        String   @id @default(cuid())
  userId    Int      @map("user_id")
  name      String   @db.VarChar(255)
  address   String?  @db.VarChar(500)
  lat       Float
  lng       Float
  category  String   @default("general") @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_favorite_user")
  @@index([lat, lng], map: "idx_favorite_coords")
  @@map("favorite_locations")
}

model Place {
  id          Int     @id @default(autoincrement())
  name        String
  description String? @db.Text

  // Location Data
  address   String?
  latitude  Float // Postgres double precision
  longitude Float // Postgres double precision

  // Metadata
  category   String  @default("GENERAL") // RESTAURANT, CAFE, CHECKIN
  coverImage String?

  // Knowledge Connection
  authorId Int
  author   User @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())

  @@index([latitude, longitude]) // Geo-spatial index preparation
}

// USER CREATED RESTAURANTS - Quán ăn do người dùng tạo
model Restaurant {
  id          Int    @id @default(autoincrement())
  userId      Int    @map("user_id")
  name        String @db.VarChar(255)
  description String @db.Text
  address     String @db.VarChar(500)
  latitude    Float
  longitude   Float

  // Optional fields
  phone      String? @db.VarChar(20)
  website    String? @db.VarChar(500)
  imageUrl   String? @map("image_url") @db.VarChar(500)
  category   String? @db.VarChar(100)
  priceLevel Int?    @map("price_level")

  // Status
  isActive   Boolean @default(true) @map("is_active")
  isVerified Boolean @default(false) @map("is_verified")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_restaurant_user")
  @@index([latitude, longitude], map: "idx_restaurant_coords")
  @@index([isActive], map: "idx_restaurant_active")
  @@index([category], map: "idx_restaurant_category")
  @@map("restaurants")
}

// OTP VERIFICATION - For phone authentication
/// @deprecated This table is legacy (Phone OTP disabled). Logic moved to Email OTP inside User table.
model OtpVerification {
  id          Int      @id @default(autoincrement())
  phoneNumber String   @map("phone_number") @db.VarChar(20)
  otpCode     String   @map("otp_code") @db.VarChar(6)
  expiresAt   DateTime @map("expires_at")
  attempts    Int      @default(0)
  isUsed      Boolean  @default(false) @map("is_used")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([phoneNumber, otpCode], map: "idx_phone_otp")
  @@index([expiresAt], map: "idx_expires")
  @@map("otp_verifications")
}

// ENUMS
enum AccountStatus {
  PENDING_VERIFY @map("pending_verify")
  ACTIVE    @map("active")
  INACTIVE  @map("inactive")
  SUSPENDED @map("suspended")
  BANNED    @map("banned")
  DELETED   @map("deleted")
  @@map("account_status")
}

enum UserRole {
  USER      @map("user")
  ADMIN     @map("admin")
  MODERATOR @map("moderator")
  @@map("role")
}

enum Gender {
  MALE   @map("male")
  FEMALE @map("female")
  OTHER  @map("other")
  @@map("gender")
}

enum ContextType {
  PLACE  @map("place")
  ENTITY @map("entity")
  TOPIC  @map("topic")
  @@map("context_type")
}

// NEW ENUMS FOR MVP
enum ArticleTier {
  TIER_0_PENDING   @map("tier_0_pending")
  TIER_1_DISCOVERY @map("tier_1_discovery")
  TIER_2_GROWTH    @map("tier_2_growth")
  TIER_3_VIRAL     @map("tier_3_viral")
  ARCHIVED         @map("archived")
  @@map("article_tier")
}

enum KVScore {
  LOW    @map("low")
  MEDIUM @map("medium")
  HIGH   @map("high")
  @@map("kv_score")
}

enum InteractionType {
  VIEW    @map("view")
  SAVE    @map("save")
  SUGGEST @map("suggest")
  REPORT  @map("report")
  UPVOTE  @map("upvote")
  @@map("interaction_type")
}

enum SuggestionStatus {
  PENDING  @map("pending")
  ACCEPTED @map("accepted")
  REJECTED @map("rejected")
  @@map("suggestion_status")
}

// KNOWLEDGE PLATFORM MODELS - Web2.5 Integration
model Article {
  id          Int     @id @default(autoincrement())
  slug        String  @unique @db.VarChar(255)
  title       String  @db.VarChar(500)
  content     String  @db.Text
  arweaveHash String? @map("arweave_hash") @db.VarChar(100)
  status      String  @default("PUBLISHED") @db.VarChar(20)

  // Algorithmic Fields (MVP)
  tier         ArticleTier @default(TIER_0_PENDING)
  rankingScore Float       @default(0.0) @map("ranking_score")
  kvScore      KVScore     @default(MEDIUM) @map("kv_score")
  isEvergreen  Boolean     @default(false) @map("is_evergreen")
  
  // Counters for BaseValue Calculation (Denormalized for Perf)
  viewCount       Int @default(0) @map("view_count")
  suggestionCount Int @default(0) @map("suggestion_count")
  saveCount       Int @default(0) @map("save_count")
  upvoteCount     Int @default(0) @map("upvote_count")

  categoryId Int      @map("category_id")
  category   Category @relation(fields: [categoryId], references: [id])

  authorId Int  @map("author_id")
  author   User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Relations
  votes        Vote[]
  history      ArticleHistory[]
  tags         Tag[]
  series       SeriesArticle[]
  contexts     ArticleContext[]
  interactions Interaction[]
  suggestions  Suggestion[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([slug], map: "idx_article_slug")
  @@index([authorId], map: "idx_article_author")
  @@index([status], map: "idx_article_status")
  @@index([tier], map: "idx_article_tier") // Critical for Traffic Pool
  @@index([rankingScore(sort: Desc)], map: "idx_ranking_score") // Critical for Feed
  @@index([kvScore], map: "idx_kv_score")
  @@map("articles")
}

// CONTENT EXPERIENCE MODELS
model ArticleHistory {
  id         Int      @id @default(autoincrement())
  articleId  Int      @map("article_id")
  editorId   Int      @map("editor_id")
  title      String   @db.VarChar(500)
  content    String   @db.Text
  changeNote String?  @map("change_note") @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  editor  User    @relation("ArticleEditor", fields: [editorId], references: [id])

  @@index([articleId], map: "idx_history_article")
  @@index([editorId], map: "idx_history_editor")
  @@map("article_histories")
}

model Category {
  id          Int     @id @default(autoincrement())
  name        String  @unique @db.VarChar(100)
  slug        String  @unique @db.VarChar(100)
  description String? @db.Text
  parentId    Int?    @map("parent_id")

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  articles Article[]

  @@index([parentId], map: "idx_category_parent")
  @@map("categories")
}

model Tag {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50)
  slug String @unique @db.VarChar(50)

  articles Article[]

  @@map("tags")
}

model Context {
  id          Int         @id @default(autoincrement())
  type        ContextType
  name        String      @db.VarChar(255)
  description String?     @db.Text
  category    String?     @db.VarChar(100)

  // PLACE-only fields
  address   String? @db.VarChar(500)
  latitude  Float?
  longitude Float?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  articles ArticleContext[]

  @@index([type], map: "idx_context_type")
  @@index([latitude, longitude], map: "idx_context_coords")
  @@index([category], map: "idx_context_category")
  @@map("contexts")
}

model ArticleContext {
  articleId Int      @map("article_id")
  contextId Int      @map("context_id")
  createdAt DateTime @default(now()) @map("created_at")

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  context Context @relation(fields: [contextId], references: [id], onDelete: Cascade)

  @@id([articleId, contextId])
  @@index([contextId], map: "idx_article_context_context")
  @@map("article_contexts")
}

// DISCOVERY MODELS
model Series {
  id          Int      @id @default(autoincrement())
  title       String   @db.VarChar(255)
  description String?  @db.Text
  authorId    Int      @map("author_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  author   User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  articles SeriesArticle[]

  @@index([authorId], map: "idx_series_author")
  @@map("series")
}

model SeriesArticle {
  seriesId  Int @map("series_id")
  articleId Int @map("article_id")
  order     Int

  series  Series  @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@id([seriesId, articleId])
  @@map("series_articles")
}

// GAMIFICATION MODELS
model Badge {
  id          Int     @id @default(autoincrement())
  name        String  @unique @db.VarChar(100)
  description String? @db.Text
  iconUrl     String? @map("icon_url") @db.VarChar(500)
  criteria    String? @db.Text // JSON or text description of how to earn

  users UserBadge[]

  @@map("badges")
}

model UserBadge {
  userId    Int      @map("user_id")
  badgeId   Int      @map("badge_id")
  awardedAt DateTime @default(now()) @map("awarded_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@id([userId, badgeId])
  @@map("user_badges")
}

model Vote {
  id        Int    @id @default(autoincrement())
  type      String @db.VarChar(10) // UP, DOWN
  userId    Int    @map("user_id")
  articleId Int    @map("article_id")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, articleId], map: "unique_user_article_vote")
  @@index([userId], map: "idx_vote_user")
  @@index([articleId], map: "idx_vote_article")
  @@map("votes")
}

model PointTransaction {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  amount     Float
  reasonCode String   @map("reason_code") @db.VarChar(50)
  refId      Int?     @map("ref_id")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_point_tx_user")
  @@index([reasonCode], map: "idx_point_tx_reason")
  @@index([createdAt], map: "idx_point_tx_created")
  @@map("point_transactions")
}

// DUAL TOKEN TRANSACTION HISTORY
model Transaction {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  type      String   @db.VarChar(20) // EARN, SPEND, WITHDRAW, DEPOSIT
  token     String   @db.VarChar(10) // KNOW_U, KNOW_G
  amount    Float
  metadata  String?  @db.Text // JSON extras
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_tx_user")
  @@index([token], map: "idx_tx_token")
  @@index([createdAt], map: "idx_tx_created")
  @@map("transactions")
}

// NEW MODELS FOR MVP

// Model Interaction: Capture signals
model Interaction {
  id        Int             @id @default(autoincrement())
  userId    Int             @map("user_id")
  articleId Int             @map("article_id")
  type      InteractionType

  // Implicit signals
  timeSpentMs        Int?  @map("time_spent_ms")
  scrollDepthPercent Int?  @map("scroll_depth_percent") // 0-100
  
  // Integrity
  locationLat  Float? @map("location_lat")
  locationLong Float? @map("location_long")

  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_interaction_user")
  @@index([articleId], map: "idx_interaction_article")
  @@index([type], map: "idx_interaction_type")
  @@map("interactions")
}

// Model Suggestion: Core contribution unit
model Suggestion {
  id        Int              @id @default(autoincrement())
  authorId  Int              @map("author_id")
  articleId Int              @map("article_id")
  content   String           @db.Text
  status    SuggestionStatus @default(PENDING)
  
  // Optional: Reason/Comment
  comment   String?          @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  author  User    @relation(fields: [authorId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([authorId], map: "idx_suggestion_author")
  @@index([articleId], map: "idx_suggestion_article")
  @@index([status], map: "idx_suggestion_status")
  @@map("suggestions")
}
